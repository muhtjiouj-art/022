<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم نجف - الإدارة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --blue: #18248b; --red: #8c0104; --white: #ffffff; --green: #27ae60; --gray: #f0f2f5; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; background: var(--gray); height: 100vh; overflow: hidden; }

        /* Login Screen */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--blue); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; }
        #loginScreen input { padding: 12px; width: 280px; margin: 10px; border-radius: 5px; border: none; font-size: 1rem; }
        #loginScreen button { padding: 12px 40px; background: var(--red); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--blue); color: white; padding: 20px 10px; display: flex; flex-direction: column; border-left: 5px solid var(--red); }
        .menu-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-right: 4px solid var(--red); }
        
        /* Main Content */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* General Forms */
        .form-box { background: white; padding: 25px; border-radius: 10px; max-width: 900px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        label { font-weight: bold; color: #555; }

        /* Tables */
        .users-table { width: 100%; border-collapse: collapse; background: white; margin-top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .users-table thead tr { background-color: #1a237e; color: white; }
        .users-table th, .users-table td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        
        /* Buttons */
        .btn-blue { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-red { background: #b71c1c; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .text-locked { color: #555; font-weight: bold; }

        /* Cards */
        .order-card { background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 5px solid var(--blue); cursor: pointer; position: relative; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .cancel-requested { border-left-color: orange !important; animation: flashOrange 1.5s infinite; }
        @keyframes flashOrange { 0%,100% { background: white; } 50% { background: #fff8e1; } }
        .cancel-badge { background: var(--red); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; position: absolute; top: 10px; left: 10px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 90%; border-top: 5px solid var(--red); max-height: 80vh; overflow-y: auto; }
        
        /* Stats */
        .dash-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .dash-card { flex: 1; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--blue); }
        
        /* Chat */
        .chat-layout { display: flex; height: 70vh; gap: 20px; }
        .chat-list { width: 250px; background: white; overflow-y: auto; border: 1px solid #ddd; }
        .chat-area { flex: 1; background: white; display: flex; flex-direction: column; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen">
        <h1>بوابة الموظفين - نجف</h1>
        <input type="text" id="username" placeholder="اسم الموظف">
        <input type="password" id="password" placeholder="كلمة المرور">
        <button id="loginBtn">دخول</button>
    </div>

    <!-- القائمة الجانبية -->
    <div class="sidebar">
        <h2 style="text-align:center;">
            <i class="fas fa-user-shield"></i> <span id="adminNameDisplay"></span>
        </h2>
        
        <!-- متاح للكل (أدمن ومتلقي) -->
        <div class="menu-item active" onclick="nav('live-orders')"><i class="fas fa-bell"></i> الطلبات الحية</div>
        <div class="menu-item" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> السجل والإحصائيات</div>
        
        <!-- عناصر خاصة بالأدمن فقط -->
        <div class="admin-only">
            <div class="menu-item" onclick="nav('reports')"><i class="fas fa-file-invoice-dollar"></i> تقارير الموظفين</div>
            <div class="menu-item" onclick="nav('products')"><i class="fas fa-plus-circle"></i> إضافة منتج</div>
            <div class="menu-item" onclick="nav('manage-products')"><i class="fas fa-boxes"></i> إدارة المنتجات</div>
            <div class="menu-item" onclick="nav('users')"><i class="fas fa-users-cog"></i> الموظفين</div>
        </div>

        <div class="menu-item" onclick="nav('chat')"><i class="fas fa-comments"></i> الشات</div>
        
        <div class="menu-item" onclick="location.reload()" style="margin-top:auto; background:var(--red);"><i class="fas fa-sign-out-alt"></i> خروج</div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="main">

        <!-- 1. الطلبات الحية -->
        <div id="live-orders" class="section active">
            <h3>متابعة الطلبات (Live)</h3>
            <div style="display: flex; gap: 20px; height: 70vh;">
                <div style="flex: 1; background: #e9ecef; border-radius: 10px; padding: 10px; overflow-y: auto;">
                    <div style="background:var(--red); color:white; padding:10px; text-align:center; border-radius:5px;">طلبات جديدة</div>
                    <div id="newOrdersList"></div>
                </div>
                <div style="flex: 1; background: #e9ecef; border-radius: 10px; padding: 10px; overflow-y: auto;">
                    <div style="background:var(--blue); color:white; padding:10px; text-align:center; border-radius:5px;">جاري التحضير</div>
                    <div id="processingOrdersList"></div>
                </div>
            </div>
        </div>

        <!-- 2. الإحصائيات (متغير حسب الشخص) -->
        <div id="dashboard" class="section">
            <h3 id="dashTitle">سجل الطلبات</h3>
            <div class="dash-container">
                <div class="dash-card"><div>شغلك اليوم</div><div id="todaySales" class="stat-val">0 ج</div></div>
                <div class="dash-card"><div>إجمالي الشهر</div><div id="monthSales" class="stat-val">0 ج</div></div>
                <div class="dash-card"><div>عدد الأوردرات</div><div id="cancelledCount" class="stat-val" style="color:var(--blue);">0</div></div>
            </div>
            
            <table class="users-table">
                <thead><tr><th>#</th><th>الوقت</th><th>العميل</th><th>المبلغ</th><th>الحالة</th><th>الموظف المستلم</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <!-- 3. التقارير (أدمن فقط) -->
        <div id="reports" class="section">
            <div class="form-box">
                <h3>تقارير أداء الموظفين</h3>
                <input type="month" id="reportMonthInput">
                <button class="btn-blue" onclick="generateReport()">عرض التقرير</button>
                <button class="btn-blue" style="background:var(--green)" onclick="window.print()">طباعة</button>
            </div>
            <div id="reportResult" style="background:white; padding:20px; margin-top:20px; display:none;">
                <h3 style="text-align:center;">تقرير شهر <span id="repMonthName"></span></h3>
                <table class="users-table"><thead><tr><th>الموظف</th><th>عدد الطلبات (المكتملة)</th><th>إجمالي المبيعات</th></tr></thead><tbody id="reportTableBody"></tbody></table>
            </div>
        </div>

        <!-- 4. إدارة الموظفين -->
        <div id="users" class="section">
            <div class="form-box">
                <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">إضافة موظف جديد</h3>
                <label>اسم الموظف</label>
                <input type="text" id="newUName">
                <label>كلمة المرور</label>
                <input type="password" id="newUPass">
                <label>الصلاحية</label>
                <select id="newURole">
                    <option value="receiver">متلقي طلبات</option>
                    <option value="admin">مدير (Admin)</option>
                </select>
                <button class="btn-blue" id="addUserBtn">إضافة موظف</button>
            </div>
            <table class="users-table">
                <thead><tr><th>حذف</th><th>الصلاحية</th><th>الاسم</th></tr></thead>
                <tbody id="usersListBody"></tbody>
            </table>
        </div>

        <!-- 5. المنتجات -->
        <div id="products" class="section">
            <div class="form-box">
                <h3>إضافة منتج</h3>
                <input type="text" id="prodName" placeholder="اسم المنتج">
                <input type="text" id="prodImg" placeholder="رابط الصورة">
                <input type="text" id="prodCatSelect" placeholder="التصنيف (شاورما..)">
                <div style="background:#f9f9f9; padding:10px; margin:10px 0;">
                    <label>الخيارات (مثال: سوري - وسط - 50)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="vBread" placeholder="النوع">
                        <input type="text" id="vSize" placeholder="الحجم">
                        <input type="number" id="vPrice" placeholder="السعر">
                    </div>
                    <button class="btn-blue" style="background:var(--green); padding:5px 15px;" id="addVarBtn">+</button>
                    <div id="tempVarsDisplay" style="margin-top:5px; color:#666;"></div>
                </div>
                <button class="btn-blue" style="width:100%" id="saveProdBtn">حفظ المنتج</button>
            </div>
            <div class="form-box">
                <h3>إضافة تصنيف</h3>
                <input type="text" id="catMain" placeholder="اسم التصنيف">
                <button class="btn-blue" id="addCatBtn">إضافة</button>
            </div>
        </div>

        <div id="manage-products" class="section">
            <h3>إدارة المنتجات</h3>
            <table class="users-table"><thead><tr><th>المنتج</th><th>الحالة</th><th>إجراء</th></tr></thead><tbody id="manageProdList"></tbody></table>
        </div>

        <!-- 6. الشات -->
        <div id="chat" class="section">
            <div class="chat-layout">
                <div class="chat-list" id="chatUsersList"></div>
                <div class="chat-area">
                    <div style="flex:1; padding:20px; overflow-y:auto;" id="adminChatBox"></div>
                    <div style="padding:10px; display:flex;"><input id="adminChatInput" style="flex:1;"><button class="btn-blue" onclick="sendAdminMsg()">إرسال</button></div>
                </div>
            </div>
        </div>

    </div>

    <!-- مودال التفاصيل -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h2 style="color:var(--blue); text-align:center;">تفاصيل الطلب</h2>
            <div id="modalBody"></div>
            <div id="cancelAlert" style="display:none; background:#fff3cd; color:#856404; padding:10px; margin:10px 0;">
                <strong>تنبيه:</strong> العميل يطلب الإلغاء! <br>السبب: <span id="cancelReasonText"></span>
            </div>
            <div id="modalActions" style="display:flex; justify-content:center; gap:10px; margin-top:20px;"></div>
            <button onclick="document.getElementById('orderModal').style.display='none'" style="width:100%; margin-top:10px; background:#ccc; color:black;">إغلاق</button>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ======================
        // إعدادات فايربيس
        // ======================
        const firebaseConfig = {
            apiKey: "AIzaSyAaf3l8VFttOCruK9jZczBsi1eBwg2U5yE",
            authDomain: "nagaf-f9b1c.firebaseapp.com",
            projectId: "nagaf-f9b1c",
            databaseURL: "https://nagaf-f9b1c-default-rtdb.firebaseio.com",
            storageBucket: "nagaf-f9b1c.appspot.com",
            messagingSenderId: "840123927886",
            appId: "1:840123927886:web:c6baad7f059cfab461e21f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUser = null;
        let activeChatUser = null;
        let tempVariants = [];
        let allOrders = {};

        // -------------------------
        //  تسجيل الدخول (Login)
        // -------------------------
        document.getElementById('loginBtn').addEventListener('click', () => {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            
            if(!u || !p) { alert("أدخل البيانات"); return; }

            onValue(ref(db, 'users'), (snap) => {
                const users = snap.val() || {};
                let found = null;

                if(u === 'admin' && p === '123') found = {name: 'Admin', role: 'admin'};
                
                if(!found) {
                    Object.values(users).forEach(user => {
                        if(user.name.trim() === u && user.pass.trim() === p) {
                            found = user;
                        }
                    });
                }

                if(found) {
                    currentUser = found;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminNameDisplay').innerText = found.name;
                    
                    // إخفاء القوائم عن المتلقي
                    if(found.role === 'receiver') {
                        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                        document.getElementById('dashTitle').innerText = "سجل عملك اليومي";
                    } else {
                        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                        document.getElementById('dashTitle').innerText = "سجل كل الطلبات (إدارة)";
                    }

                    startSystem();
                } else {
                    alert('بيانات الدخول غير صحيحة');
                }
            }, {onlyOnce: true});
        });

        // --- التنقل ---
        window.nav = function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- تشغيل النظام ---
        function startSystem() {
            // الطلبات (أهم جزء)
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val() || {};
                allOrders = data;
                renderOrders(data);
                updateStats(data);
            });
            // الموظفين
            onValue(ref(db, 'users'), (snapshot) => renderUsers(snapshot.val() || {}));
            // المنتجات
            onValue(ref(db, 'products'), (snapshot) => renderProdManage(snapshot.val() || {}));
            // الشات
            onValue(ref(db, 'chats'), (snapshot) => {
                renderChatList(snapshot.val() || {});
                if(activeChatUser) loadAdminChat(activeChatUser);
            });
        }

        // -------------------------
        //  إدارة الموظفين
        // -------------------------
        document.getElementById('addUserBtn').addEventListener('click', () => {
            let u = document.getElementById('newUName').value;
            let p = document.getElementById('newUPass').value;
            let r = document.getElementById('newURole').value;
            if(u && p) {
                push(ref(db, 'users'), {name:u, pass:p, role:r});
                document.getElementById('newUName').value=''; 
                document.getElementById('newUPass').value='';
                alert('تم إضافة الموظف');
            }
        });

        function renderUsers(data) {
            const tbody = document.getElementById('usersListBody');
            tbody.innerHTML = '';
            tbody.innerHTML += `<tr><td><span class="text-locked">لا يمكن حذفه</span></td><td>مدير عام</td><td>Admin</td></tr>`;

            Object.entries(data).forEach(([key, user]) => {
                if(user.role !== 'customer') { 
                    let roleTxt = user.role === 'admin' ? 'مدير' : 'متلقي طلبات';
                    tbody.innerHTML += `
                    <tr>
                        <td><button class="btn-red" onclick="window.delUser('${key}')">حذف</button></td>
                        <td>${roleTxt}</td>
                        <td>${user.name}</td>
                    </tr>`;
                }
            });
        }
        window.delUser = function(key) { if(confirm('حذف الموظف؟')) remove(ref(db, 'users/'+key)); }

        // -------------------------
        //  الطلبات
        // -------------------------
        function renderOrders(data) {
            const newDiv = document.getElementById('newOrdersList');
            const procDiv = document.getElementById('processingOrdersList');
            newDiv.innerHTML = ''; procDiv.innerHTML = '';

            Object.entries(data).forEach(([key, o]) => {
                const card = `<div class="order-card ${o.cancelRequest?'cancel-requested':''}" onclick="openOrder('${key}')">
                    ${o.cancelRequest ? '<span class="cancel-badge">طلب إلغاء!</span>' : ''}
                    <h4>#${key.slice(-4)} - ${o.customerName||'عميل'}</h4>
                    <div>${o.address||''}</div>
                    <div>${o.total} ج</div>
                </div>`;
                
                if(o.status === 'pending' || o.status === 'new') {
                    if(!o.seenByAdmin) { document.getElementById('alarmSound').play().catch(()=>{}); update(ref(db, 'orders/'+key), {seenByAdmin:true}); }
                    newDiv.innerHTML += card;
                } else if(o.status === 'processing') {
                    procDiv.innerHTML += card;
                }
            });
        }

        window.openOrder = function(key) {
            const o = allOrders[key];
            if(!o) return;
            let itemsHtml = (o.items||o.cart||[]).map(i => `<li>${i.name||i.item} - ${i.variant?i.variant.price:i.price} ج</li>`).join('');
            document.getElementById('modalBody').innerHTML = `
                <p><strong>العميل:</strong> ${o.customerName} (${o.phone})</p>
                <p><strong>العنوان:</strong> ${o.address}</p>
                <hr><ul>${itemsHtml}</ul>
                <h3 style="color:var(--red)">الإجمالي: ${o.total} ج</h3>
            `;
            
            const actions = document.getElementById('modalActions');
            const alertBox = document.getElementById('cancelAlert');
            
            // إلغاء من العميل
            if(o.cancelRequest) {
                alertBox.style.display = 'block';
                document.getElementById('cancelReasonText').innerText = o.cancelReason;
                actions.innerHTML = `<button class="btn-red" onclick="upStatus('${key}','cancelled')">موافقة</button><button class="btn-blue" onclick="rejCancel('${key}')">رفض</button>`;
            } else {
                alertBox.style.display = 'none';
                if(o.status === 'pending' || o.status === 'new') {
                    actions.innerHTML = `<button class="btn-blue" style="background:var(--green)" onclick="upStatus('${key}','processing')">قبول وتجهيز</button><button class="btn-red" onclick="upStatus('${key}','cancelled')">رفض</button>`;
                } else if(o.status === 'processing') {
                    actions.innerHTML = `<button class="btn-blue" onclick="upStatus('${key}','completed')">إنهاء</button>`;
                }
            }
            document.getElementById('orderModal').style.display = 'block';
        }

        // تحديث الحالة وحفظ اسم الموظف
        window.upStatus = function(k,s) { 
            update(ref(db,'orders/'+k), {
                status:s, 
                cancelRequest:false,
                handledBy: currentUser.name  // هام جداً للتقارير
            }); 
            document.getElementById('orderModal').style.display='none'; 
        }
        window.rejCancel = function(k) { update(ref(db,'orders/'+k), {cancelRequest:false}); document.getElementById('orderModal').style.display='none'; }

        // -------------------------
        //  الإحصائيات والسجلات (معدلة)
        // -------------------------
        function updateStats(data) {
            let relevantOrders = Object.values(data);

            // لو متلقي طلبات -> يرى فقط طلباته التي قبلها
            if (currentUser.role === 'receiver') {
                relevantOrders = relevantOrders.filter(o => o.handledBy === currentUser.name);
            }

            let comp = relevantOrders.filter(o=>o.status==='completed');
            let canc = relevantOrders.filter(o=>o.status==='cancelled');
            let total = comp.reduce((s,o)=>s+(parseInt(o.total)||0),0);
            
            document.getElementById('todaySales').innerText = total + ' ج'; // تبسيطاً اليوم
            document.getElementById('monthSales').innerText = total + ' ج';
            document.getElementById('cancelledCount').innerText = relevantOrders.length; // عدد الأوردرات الكلي
            
            // جدول السجل
            document.getElementById('historyTableBody').innerHTML = relevantOrders.reverse().map(o=>`
                <tr>
                    <td>#</td>
                    <td>${new Date(o.timestamp).toLocaleTimeString('ar-EG')}</td>
                    <td>${o.customerName}</td>
                    <td>${o.total} ج</td>
                    <td style="color:${o.status==='completed'?'green':'red'}">${o.status==='completed'?'مكتمل':(o.status==='cancelled'?'ملغي':'جاري')}</td>
                    <td>${o.handledBy || '-'}</td>
                </tr>`).join('');
        }

        // -------------------------
        //  التقارير (للأدمن فقط)
        // -------------------------
        window.generateReport = function() {
            const m = document.getElementById('reportMonthInput').value;
            if(!m) return alert('اختر الشهر');
            
            // فلترة الطلبات المكتملة في الشهر المحدد
            const filtered = Object.values(allOrders).filter(o => 
                o.status === 'completed' && 
                new Date(o.timestamp).toISOString().slice(0,7) === m
            );
            
            // تجميع البيانات حسب الموظف
            let stats = {};
            filtered.forEach(o => {
                let emp = o.handledBy || 'غير محدد';
                if(!stats[emp]) stats[emp] = {count:0, total:0};
                stats[emp].count++; 
                stats[emp].total += parseInt(o.total || 0);
            });

            document.getElementById('repMonthName').innerText = m;
            document.querySelector('#reportTableBody').innerHTML = Object.keys(stats).map(k => 
                `<tr><td>${k}</td><td>${stats[k].count}</td><td>${stats[k].total} ج</td></tr>`
            ).join('');
            
            document.getElementById('reportResult').style.display = 'block';
        }

        // --- المنتجات (باقي الكود كما هو) ---
        document.getElementById('addVarBtn').addEventListener('click', () => {
            let b=document.getElementById('vBread').value, s=document.getElementById('vSize').value, p=document.getElementById('vPrice').value;
            if(p) { tempVariants.push({bread:b,size:s,price:parseInt(p)}); document.getElementById('tempVarsDisplay').innerText += `${b}-${s} (${p}ج) | `; }
        });
        document.getElementById('saveProdBtn').addEventListener('click', () => {
            let n=document.getElementById('prodName').value, i=document.getElementById('prodImg').value, c=document.getElementById('prodCatSelect').value;
            if(n && tempVariants.length) { push(ref(db,'products'),{name:n,img:i,cat:c,variants:tempVariants,available:true}); alert('تم'); tempVariants=[]; document.getElementById('prodName').value=''; document.getElementById('tempVarsDisplay').innerText=''; }
        });
        document.getElementById('addCatBtn').addEventListener('click', () => {
            let n=document.getElementById('catMain').value; if(n){ push(ref(db,'categories'),{name:n}); alert('تم'); }
        });
        function renderProdManage(data) {
            document.getElementById('manageProdList').innerHTML = Object.entries(data).map(([k,p])=>`<tr><td>${p.name}</td><td>${p.available?'متاح':'متوقف'}</td><td><button class="btn-blue" onclick="window.togProd('${k}',${p.available})">تغيير</button><button class="btn-red" onclick="window.delProd('${k}')">حذف</button></td></tr>`).join('');
        }
        window.togProd = function(k,c) { update(ref(db,'products/'+k),{available:!c}); }
        window.delProd = function(k) { if(confirm('حذف؟')) remove(ref(db,'products/'+k)); }

        // --- الشات ---
        function renderChatList(data) {
            document.getElementById('chatUsersList').innerHTML = Object.keys(data).map(k=>`<div onclick="window.loadChat('${k}')" style="padding:10px;border-bottom:1px solid #ddd;cursor:pointer;">${k}</div>`).join('');
        }
        window.loadChat = function(p) { activeChatUser=p; onValue(ref(db,'chats/'+p), (s)=>{ let m=s.val()||{}; document.getElementById('adminChatBox').innerHTML=Object.values(m).map(x=>`<div style="background:${x.sender==='admin'?'var(--blue)':'#ddd'};color:${x.sender==='admin'?'white':'black'};padding:8px;margin:5px;border-radius:5px;align-self:${x.sender==='admin'?'flex-end':'flex-start'};width:fit-content;">${x.text}</div>`).join(''); }); }
        window.sendAdminMsg = function() {
            let t=document.getElementById('adminChatInput').value; if(t&&activeChatUser) { push(ref(db,'chats/'+activeChatUser),{sender:'admin',text:t}); document.getElementById('adminChatInput').value=''; }
        }
    </script>
</body>
</html>
