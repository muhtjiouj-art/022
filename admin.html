<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم نجف - الإدارة (Online)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --blue: #18248b; --red: #8c0104; --white: #ffffff; --green: #27ae60; --gray: #f0f2f5; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; background: var(--gray); height: 100vh; overflow: hidden; }

        /* Login Screen */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--blue); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        #loginScreen input { padding: 10px; width: 250px; margin: 10px; border-radius: 5px; border: none; }
        #loginScreen button { padding: 10px 30px; background: var(--red); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Sidebar & Layout */
        .sidebar { width: 260px; background: var(--blue); color: white; padding: 20px 10px; display: flex; flex-direction: column; border-left: 5px solid var(--red); }
        .menu-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-right: 4px solid var(--red); }
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* UI Components */
        .form-box { background: white; padding: 20px; border-radius: 10px; max-width: 800px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; }
        th { background: var(--blue); color: white; padding: 10px; }
        td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        
        button { cursor: pointer; border: none; padding: 8px 15px; border-radius: 4px; color: white; font-weight: bold; margin: 2px; }
        .btn-blue { background: var(--blue); }
        .btn-green { background: var(--green); }
        .btn-red { background: var(--red); }

        /* Dashboard Stats */
        .dash-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .dash-card { flex: 1; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--blue); }

        /* Order Cards & Alerts */
        .order-card { background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 5px solid var(--blue); cursor: pointer; position: relative; transition: 0.2s; }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .cancel-requested { border-left-color: orange !important; animation: flashOrange 1.5s infinite; }
        @keyframes flashOrange { 0%,100% { background: white; } 50% { background: #fff8e1; } }
        .cancel-badge { background: var(--red); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; position: absolute; top: 10px; left: 10px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 90%; border-top: 5px solid var(--red); max-height: 80vh; overflow-y: auto; }

        /* Chat Layout */
        .chat-layout { display: flex; height: 70vh; gap: 20px; }
        .chat-list { width: 250px; background: white; overflow-y: auto; border: 1px solid #ddd; }
        .chat-area { flex: 1; background: white; display: flex; flex-direction: column; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <!-- Login -->
    <div id="loginScreen">
        <h1>بوابة الموظفين - نجف</h1>
        <input type="text" id="username" placeholder="اسم المستخدم (admin)">
        <input type="password" id="password" placeholder="كلمة المرور (123)">
        <button id="loginBtn">دخول</button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <h2 style="text-align:center;">إدارة المطعم</h2>
        <div class="menu-item active" onclick="nav('live-orders')"><i class="fas fa-bell"></i> الطلبات الحية</div>
        <div class="menu-item" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> الإحصائيات</div>
        <div class="menu-item" onclick="nav('products')"><i class="fas fa-plus-circle"></i> إضافة منتج</div>
        <div class="menu-item" onclick="nav('manage-products')"><i class="fas fa-boxes"></i> إدارة المنتجات</div>
        <div class="menu-item" onclick="nav('users')"><i class="fas fa-users-cog"></i> الموظفين</div>
        <div class="menu-item" onclick="nav('chat')"><i class="fas fa-comments"></i> الشات</div>
        <div class="menu-item" onclick="location.reload()" style="margin-top:auto; background:var(--red);"><i class="fas fa-sign-out-alt"></i> خروج</div>
    </div>

    <!-- Main Content -->
    <div class="main">

        <!-- Live Orders -->
        <div id="live-orders" class="section active">
            <h3>متابعة الطلبات (Live)</h3>
            <div style="display: flex; gap: 20px; height: 70vh;">
                <!-- New Orders -->
                <div style="flex: 1; background: #e9ecef; border-radius: 10px; padding: 10px; overflow-y: auto;">
                    <div style="background:var(--red); color:white; padding:10px; text-align:center; border-radius:5px;">طلبات جديدة</div>
                    <div id="newOrdersList"></div>
                </div>
                <!-- Processing Orders -->
                <div style="flex: 1; background: #e9ecef; border-radius: 10px; padding: 10px; overflow-y: auto;">
                    <div style="background:var(--blue); color:white; padding:10px; text-align:center; border-radius:5px;">جاري التحضير</div>
                    <div id="processingOrdersList"></div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section">
            <div class="dash-container">
                <div class="dash-card">
                    <div>مبيعات اليوم</div>
                    <div id="todaySales" class="stat-val">0 ج</div>
                </div>
                <div class="dash-card">
                    <div>مبيعات الشهر</div>
                    <div id="monthSales" class="stat-val">0 ج</div>
                </div>
                <div class="dash-card">
                    <div>طلبات ملغاة</div>
                    <div id="cancelledCount" class="stat-val" style="color:var(--red);">0</div>
                </div>
            </div>
            <h3>سجل الطلبات (مكتمل / ملغي)</h3>
            <table id="historyTable"><thead><tr><th>#</th><th>الوقت</th><th>العميل</th><th>المبلغ</th><th>الحالة</th><th>سبب الإلغاء/الرفض</th></tr></thead><tbody></tbody></table>
        </div>

        <!-- Add Product -->
        <div id="products" class="section">
            <div class="form-box">
                <h3>إضافة منتج جديد</h3>
                <input type="text" id="prodName" placeholder="اسم المنتج">
                <input type="text" id="prodImg" placeholder="رابط الصورة">
                <input type="text" id="prodCatSelect" placeholder="تصنيف (شاورما/برجر..)">
                <div style="background:#f1f4f9; padding:15px; margin-top:10px;">
                    <h4>الخيارات والسعر:</h4>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="vBread" placeholder="النوع (سوري/كايزر..)">
                        <input type="text" id="vSize" placeholder="الحجم (وسط/كبير..)">
                        <input type="number" id="vPrice" placeholder="السعر">
                    </div>
                    <button class="btn-green" id="addVarBtn">+ إضافة خيار</button>
                    <div id="tempVarsDisplay"></div>
                </div>
                <button class="btn-blue" style="width:100%; margin-top:15px;" id="saveProdBtn">حفظ المنتج</button>
            </div>
        </div>

        <!-- Manage Products -->
        <div id="manage-products" class="section">
            <h3>إدارة المنتجات</h3>
            <table style="width:100%;"><thead><tr><th>المنتج</th><th>الحالة</th><th>إجراء</th></tr></thead><tbody id="manageProdList"></tbody></table>
        </div>

        <!-- Users -->
        <div id="users" class="section">
            <div class="form-box">
                <h3>إضافة موظف</h3>
                <input type="text" id="newUName" placeholder="اسم الموظف">
                <input type="password" id="newUPass" placeholder="كلمة المرور">
                <button class="btn-blue" id="addUserBtn">إضافة</button>
            </div>
            <table id="usersTable"><thead><tr><th>الاسم</th><th>حذف</th></tr></thead><tbody id="usersListBody"></tbody></table>
        </div>

        <!-- Chat -->
        <div id="chat" class="section">
            <div class="chat-layout">
                <div class="chat-list" id="chatUsersList"></div>
                <div class="chat-area">
                    <div style="flex:1; padding:20px; overflow-y:auto;" id="adminChatBox"></div>
                    <div style="padding:10px; display:flex;"><input id="adminChatInput" style="flex:1;"><button class="btn-blue" onclick="sendAdminMsg()">إرسال</button></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Order Detail Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h2 style="color:var(--blue); text-align:center;">تفاصيل الطلب</h2>
            <div id="modalBody"></div>
            
            <!-- تنبيه طلب الإلغاء -->
            <div id="cancelAlert" style="display:none; background:#fff3cd; color:#856404; padding:10px; border:1px solid #ffeeba; margin:10px 0;">
                <strong><i class="fas fa-exclamation-triangle"></i> تنبيه:</strong> العميل يطلب إلغاء هذا الأوردر!
                <div id="cancelReasonText" style="margin-top:5px; border-top:1px solid #ddd; padding-top:5px; font-weight:bold;"></div>
            </div>
            
            <div id="modalActions" style="display:flex; justify-content:center; gap:10px; margin-top:20px;"></div>
            <button onclick="document.getElementById('orderModal').style.display='none'" style="width:100%; margin-top:10px; background:#ccc; color:black;">إغلاق</button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // إعدادات فايربيس الخاصة بك
        const firebaseConfig = {
            apiKey: "AIzaSyAaf3l8VFttOCruK9jZczBsi1eBwg2U5yE",
            authDomain: "nagaf-f9b1c.firebaseapp.com",
            projectId: "nagaf-f9b1c",
            databaseURL: "https://nagaf-f9b1c-default-rtdb.firebaseio.com",
            storageBucket: "nagaf-f9b1c.appspot.com",
            messagingSenderId: "840123927886",
            appId: "1:840123927886:web:c6baad7f059cfab461e21f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUser = null;
        let activeChatUser = null;
        let tempVariants = [];
        let allOrders = {};
        let allProducts = {};

        // --- Auth ---
        document.getElementById('loginBtn').addEventListener('click', () => {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            // تحقق بسيط من الأدمن (يمكنك تطويره لجلب المستخدمين من القاعدة)
            onValue(ref(db, 'users'), (snap) => {
                const users = snap.val() || {};
                // إضافة الأدمن الافتراضي إذا لم يكن موجوداً
                let found = (u === 'admin' && p === '123') ? {name:'admin'} : null;
                
                if(!found) {
                    Object.values(users).forEach(user => {
                        if(user.name === u && user.pass === p) found = user;
                    });
                }

                if(found) {
                    currentUser = found;
                    document.getElementById('loginScreen').style.display = 'none';
                    startSystem();
                } else {
                    alert('بيانات خاطئة');
                }
            }, {onlyOnce: true});
        });

        // --- Navigation ---
        window.nav = function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- System Loop (Realtime Listeners) ---
        function startSystem() {
            // 1. Orders Listener
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val() || {};
                allOrders = data;
                renderOrders(data);
                updateStats(data);
            });

            // 2. Products Listener
            onValue(ref(db, 'products'), (snapshot) => {
                const data = snapshot.val() || {};
                allProducts = data;
                renderProdManage(data);
            });

            // 3. Users Listener
            onValue(ref(db, 'users'), (snapshot) => {
                renderUsers(snapshot.val() || {});
            });

            // 4. Chat Listener
            onValue(ref(db, 'chats'), (snapshot) => {
                renderChatList(snapshot.val() || {});
                if(activeChatUser) loadAdminChat(activeChatUser);
            });
        }

        function renderOrders(data) {
            const newOrdersDiv = document.getElementById('newOrdersList');
            const procOrdersDiv = document.getElementById('processingOrdersList');
            newOrdersDiv.innerHTML = '';
            procOrdersDiv.innerHTML = '';

            Object.entries(data).forEach(([key, o]) => {
                const card = createOrderCard(key, o);
                
                if(o.status === 'new' || o.status === 'pending') { // New orders
                    // Sound Alert for unseen orders
                    if(!o.seenByAdmin) {
                        document.getElementById('alarmSound').play().catch(()=>{});
                        update(ref(db, 'orders/'+key), {seenByAdmin: true});
                    }
                    newOrdersDiv.innerHTML += card;
                } 
                else if(o.status === 'processing') {
                    procOrdersDiv.innerHTML += card;
                }
            });
        }

        function createOrderCard(key, o) {
            let cancelClass = o.cancelRequest ? 'cancel-requested' : '';
            let cancelBadge = o.cancelRequest ? '<span class="cancel-badge">طلب إلغاء!</span>' : '';
            // Handle different structure (some use 'items', some use 'cart')
            let itemCount = o.cart ? o.cart.length : (o.items ? o.items.length : 0);
            let customerName = o.customerName || o.name || 'غير معروف';

            return `<div class="order-card ${cancelClass}" onclick="openOrder('${key}')">
                ${cancelBadge}
                <h4>#${key.slice(-4)} - ${customerName}</h4>
                <div style="font-size:0.9rem; color:#555;">${o.address || 'غير محدد'}</div>
                <div>${itemCount} صنف | ${o.total} ج</div>
            </div>`;
        }

        window.openOrder = function(key) {
            const o = allOrders[key];
            if(!o) return;

            let customerName = o.customerName || o.name;
            let phone = o.phone || (o.customer ? o.customer.phone : '');
            let itemsList = o.cart || o.items || [];
            
            // Generate Items HTML
            let itemsHtml = itemsList.map(i => {
                // Handle different item structures
                let name = i.name || i.item;
                let variant = i.variant ? `(${i.variant.bread})` : '';
                let price = i.variant ? i.variant.price : i.price;
                return `<li>${name} ${variant} - ${price} ج</li>`;
            }).join('');

            document.getElementById('modalBody').innerHTML = `
                <p><strong>العميل:</strong> ${customerName} (${phone})</p>
                <p><strong>العنوان:</strong> ${o.address}</p>
                <hr><ul>${itemsHtml}</ul>
                <h3 style="color:var(--red)">الإجمالي: ${o.total} ج</h3>
            `;

            const actions = document.getElementById('modalActions');
            const alertBox = document.getElementById('cancelAlert');

            // Cancel Request Logic
            if(o.cancelRequest) {
                alertBox.style.display = 'block';
                document.getElementById('cancelReasonText').innerText = `سبب العميل: ${o.cancelReason || 'غير محدد'}`;
                
                actions.innerHTML = `
                    <button class="btn-red" onclick="approveCancel('${key}', '${o.cancelReason}')">✔ موافقة على الإلغاء</button>
                    <button class="btn-blue" onclick="rejectCancelReq('${key}')">✖ رفض الإلغاء (استكمال)</button>
                `;
            } else {
                alertBox.style.display = 'none';
                if(o.status === 'new' || o.status === 'pending') {
                    actions.innerHTML = `<button class="btn-green" onclick="updateStatus('${key}', 'processing')">قبول وتجهيز</button> <button class="btn-red" onclick="rejectOrderWithReason('${key}')">رفض الطلب</button>`;
                } else if(o.status === 'processing') {
                    actions.innerHTML = `<button class="btn-blue" onclick="updateStatus('${key}', 'completed')">إنهاء ونقل للسجل</button>`;
                }
            }
            document.getElementById('orderModal').style.display = 'block';
        }

        window.updateStatus = function(key, st) {
            update(ref(db, 'orders/'+key), {
                status: st,
                cancelRequest: false,
                handledBy: currentUser.name
            });
            document.getElementById('orderModal').style.display='none';
        }

        window.rejectOrderWithReason = function(key) {
            const reason = prompt("يرجى كتابة سبب رفض الطلب (سيظهر للعميل):");
            if(reason) {
                update(ref(db, 'orders/'+key), {
                    status: 'cancelled',
                    rejectionReason: reason,
                    handledBy: currentUser.name
                });
                document.getElementById('orderModal').style.display='none';
            }
        }

        window.approveCancel = function(key, reason) {
            if(confirm('موافقة على الإلغاء؟')) {
                update(ref(db, 'orders/'+key), {
                    status: 'cancelled',
                    rejectionReason: `إلغاء من العميل: ${reason}`
                });
                document.getElementById('orderModal').style.display='none';
            }
        }

        window.rejectCancelReq = function(key) {
            if(confirm('رفض طلب الإلغاء واستكمال التجهيز؟')) {
                update(ref(db, 'orders/'+key), { cancelRequest: false });
                document.getElementById('orderModal').style.display='none';
            }
        }

        // --- Dashboard & Reports ---
        function updateStats(data) {
            let completed = [], cancelled = [];
            Object.values(data).forEach(o => {
                if(o.status === 'completed') completed.push(o);
                if(o.status === 'cancelled') cancelled.push(o);
            });
            
            const today = new Date().toLocaleDateString('ar-EG'); // Simple check (improve if needed)
            const todaySales = completed.reduce((s,o)=>s+(parseInt(o.total)||0), 0); 
            // Note: Accurate "Today" check requires parsing timestamp properly
            
            document.getElementById('todaySales').innerText = todaySales + ' ج'; // Simplified for now
            document.getElementById('monthSales').innerText = todaySales + ' ج'; // Placeholder
            document.getElementById('cancelledCount').innerText = cancelled.length;

            // History Table
            const historyList = Object.values(data).filter(o => o.status === 'completed' || o.status === 'cancelled');
            document.querySelector('#historyTable tbody').innerHTML = historyList.reverse().map(o => {
                let stColor = o.status === 'completed' ? 'green' : 'red';
                let stText = o.status === 'completed' ? 'مكتمل' : 'ملغي';
                let reason = o.rejectionReason || o.cancelReason || '-';
                let cName = o.customerName || o.name || 'عميل';
                let dateStr = o.timestamp ? new Date(o.timestamp).toLocaleTimeString('ar-EG') : '-';
                return `
                <tr>
                    <td>#</td>
                    <td>${dateStr}</td>
                    <td>${cName}</td>
                    <td>${o.total} ج</td>
                    <td style="color:${stColor}; font-weight:bold;">${stText}</td>
                    <td style="font-size:0.9rem;">${reason}</td>
                </tr>
            `}).join('');
        }

        // --- Products ---
        document.getElementById('addVarBtn').addEventListener('click', () => {
            const b = document.getElementById('vBread').value, s = document.getElementById('vSize').value, p = document.getElementById('vPrice').value;
            if(b && s && p) {
                tempVariants.push({bread:b, size:s, price:parseInt(p)});
                document.getElementById('tempVarsDisplay').innerText = tempVariants.map(v=>`${v.bread}-${v.size} (${v.price})`).join(', ');
                document.getElementById('vBread').value=''; document.getElementById('vPrice').value='';
            }
        });

        document.getElementById('saveProdBtn').addEventListener('click', () => {
            const n = document.getElementById('prodName').value, i = document.getElementById('prodImg').value, c = document.getElementById('prodCatSelect').value;
            if(n && tempVariants.length) {
                push(ref(db, 'products'), {
                    name:n, img:i, cat:c, variants:tempVariants, available:true
                });
                alert('تم الحفظ'); tempVariants=[]; document.getElementById('prodName').value='';
            }
        });

        function renderProdManage(data) {
            document.getElementById('manageProdList').innerHTML = Object.entries(data).map(([key, p]) => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.available?'متاح':'متوقف'}</td>
                    <td>
                        <button class="btn-blue" onclick="window.toggleProd('${key}', ${p.available})">تغيير</button> 
                        <button class="btn-red" onclick="window.delProd('${key}')">حذف</button>
                    </td>
                </tr>
            `).join('');
        }

        window.toggleProd = function(key, current) {
            update(ref(db, 'products/'+key), { available: !current });
        }
        window.delProd = function(key) {
            if(confirm('حذف المنتج؟')) remove(ref(db, 'products/'+key));
        }

        // --- Users ---
        document.getElementById('addUserBtn').addEventListener('click', () => {
            let u = document.getElementById('newUName').value, p = document.getElementById('newUPass').value;
            if(u && p) {
                push(ref(db, 'users'), {name:u, pass:p});
                document.getElementById('newUName').value=''; document.getElementById('newUPass').value='';
            }
        });

        function renderUsers(data) {
            document.getElementById('usersListBody').innerHTML = Object.entries(data).map(([key, u]) => 
                `<tr><td>${u.name}</td><td><button class="btn-red" onclick="window.delUser('${key}')">x</button></td></tr>`
            ).join('');
        }
        window.delUser = function(key) { remove(ref(db, 'users/'+key)); }

        // --- Chat ---
        function renderChatList(data) {
            const list = document.getElementById('chatUsersList');
            list.innerHTML = Object.keys(data).map(k => `<div onclick="window.loadChat('${k}')" style="padding:10px; border-bottom:1px solid #ddd; cursor:pointer; background:${activeChatUser===k?'#eee':'white'}">${k}</div>`).join('');
        }
        
        window.loadChat = function(phone) {
            activeChatUser = phone;
            loadAdminChat(phone);
        }

        window.loadAdminChat = function(phone) {
            // Re-fetch logic or rely on cached data if simple
            onValue(ref(db, 'chats/'+phone), (snap) => {
                const msgs = snap.val() || {};
                document.getElementById('adminChatBox').innerHTML = Object.values(msgs).map(m => `<div style="background:${m.sender==='admin'?'var(--blue)':'#ddd'}; color:${m.sender==='admin'?'white':'black'}; padding:8px; margin:5px; border-radius:5px; align-self:${m.sender==='admin'?'flex-end':'flex-start'}; width:fit-content;">${m.text}</div>`).join('');
            });
        }

        window.sendAdminMsg = function() {
            let t = document.getElementById('adminChatInput').value;
            if(t && activeChatUser) {
                push(ref(db, 'chats/'+activeChatUser), {sender:'admin', text:t});
                document.getElementById('adminChatInput').value='';
            }
        }
    </script>
</body>
</html>
