<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم نجف - الإدارة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --blue: #18248b; --red: #8c0104; --white: #ffffff; --green: #27ae60; --gray: #f0f2f5; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; background: var(--gray); height: 100vh; overflow: hidden; }

        /* Login */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--blue); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; }
        #loginScreen input { padding: 12px; width: 280px; margin: 10px; border-radius: 5px; border: none; font-size: 1rem; }
        #loginScreen button { padding: 12px 40px; background: var(--red); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--blue); color: white; padding: 20px 10px; display: flex; flex-direction: column; border-left: 5px solid var(--red); }
        .menu-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; position: relative; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-right: 4px solid var(--red); }
        .notification-dot { width: 10px; height: 10px; background: red; border-radius: 50%; position: absolute; left: 15px; display: none; box-shadow: 0 0 5px white; }

        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* General */
        .form-box { background: white; padding: 25px; border-radius: 10px; max-width: 900px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .users-table { width: 100%; border-collapse: collapse; background: white; margin-top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .users-table thead tr { background-color: #1a237e; color: white; }
        .users-table th, .users-table td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        .btn-blue { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-red { background: #b71c1c; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-warning { background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 5px; }

        /* Order Cards */
        .order-card { background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 5px solid var(--blue); cursor: pointer; position: relative; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .cancel-requested { border-left-color: orange !important; background-color: #fff8e1; animation: flashOrange 1.5s infinite alternate; }
        @keyframes flashOrange { from { box-shadow: 0 0 5px orange; } to { box-shadow: 0 0 15px orange; } }
        .cancel-badge { background: var(--red); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; position: absolute; top: 10px; left: 10px; z-index: 10; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 90%; border-top: 5px solid var(--red); max-height: 80vh; overflow-y: auto; }
        
        /* Stats */
        .dash-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .dash-card { flex: 1; min-width: 150px; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--blue); }
        
        /* Chat */
        .chat-layout { display: flex; height: 70vh; gap: 20px; }
        .chat-list { width: 250px; background: white; overflow-y: auto; border: 1px solid #ddd; }
        .chat-area { flex: 1; background: white; display: flex; flex-direction: column; border: 1px solid #ddd; }
        .chat-user-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .chat-user-item:hover { background: #f1f1f1; }
        .chat-user-item.has-new { background: #e3f2fd; font-weight: bold; }
        
        .item-note { color: #d32f2f; font-weight: bold; display: block; margin-top: 4px; font-size: 0.95rem; background: #fff5f5; padding: 2px 5px; border-radius: 4px; width: fit-content; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background-color: #f1f1f1; }
        .reason-box { background: #ffebee; color: #b71c1c; padding: 15px; margin: 15px 0; border-radius: 5px; border: 1px solid #ffcdd2; }
    </style>
</head>
<body>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" loop></audio>
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3"></audio>

    <div id="loginScreen">
        <h1>بوابة الموظفين - نجف</h1>
        <input type="text" id="username" placeholder="اسم الموظف">
        <input type="password" id="password" placeholder="كلمة المرور">
        <button id="loginBtn">دخول</button>
    </div>

    <div class="sidebar">
        <div style="text-align:center; margin-bottom:10px;">
            <img src="logo.png" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--red); background:white;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1996/1996068.png'">
        </div>
        <h2 style="text-align:center; margin-top:0;">
             <span id="adminNameDisplay"></span>
        </h2>
        <div class="menu-item active" onclick="nav('live-orders')"><i class="fas fa-bell"></i> الطلبات الحية</div>
        <div class="menu-item" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> السجل والإحصائيات</div>
        
        <!-- تم نقل إدارة المنتجات هنا لتظهر للمتلقي أيضاً -->
        <div class="menu-item" onclick="nav('manage-products')"><i class="fas fa-boxes"></i> إدارة المنتجات</div>
        
        <div class="admin-only">
            <div class="menu-item" onclick="nav('reports')"><i class="fas fa-file-invoice-dollar"></i> التقارير</div>
            <div class="menu-item" onclick="nav('products')"><i class="fas fa-plus-circle"></i> إضافة منتج جديد</div>
            <div class="menu-item" onclick="nav('users')"><i class="fas fa-users-cog"></i> الموظفين</div>
        </div>

        <div class="menu-item" id="chatMenuItem" onclick="nav('chat')">
            <i class="fas fa-comments"></i> الشات 
            <span class="notification-dot" id="chatNotifyDot"></span>
        </div>
        <div class="menu-item" onclick="logoutStaff()" style="margin-top:auto; background:var(--red);"><i class="fas fa-sign-out-alt"></i> خروج</div>
    </div>

    <div class="main">

        <!-- 1. Live Orders -->
        <div id="live-orders" class="section active">
            <h3>متابعة الطلبات (Live)</h3>
            <div style="display: flex; gap: 20px; height: 70vh;">
                <div style="flex: 1; background: #e9ecef; border-radius: 10px; padding: 10px; overflow-y: auto;">
                    <div style="background:var(--red); color:white; padding:10px; text-align:center; border-radius:5px;">طلبات جديدة (مراجعة النطاق)</div>
                    <div id="newOrdersList"></div>
                </div>
                <div style="flex: 1; background: #e9ecef; border-radius: 10px; padding: 10px; overflow-y: auto;">
                    <div style="background:var(--blue); color:white; padding:10px; text-align:center; border-radius:5px;">جاري التحضير</div>
                    <div id="processingOrdersList"></div>
                </div>
            </div>
        </div>

        <!-- 2. Dashboard -->
        <div id="dashboard" class="section">
            <h3 id="dashTitle">سجل الطلبات</h3>
            <div class="form-box" style="padding:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <div style="flex:2; display:flex; align-items:center; gap:5px;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchPhoneInput" placeholder="بحث برقم الهاتف..." onkeyup="filterHistory()" style="margin:0;">
                </div>
                <div style="flex:1;">
                    <select id="filterStatus" onchange="filterHistory()" style="margin:0; padding:10px;">
                        <option value="all">كل الحالات</option>
                        <option value="completed">مكتمل</option>
                        <option value="cancelled">ملغي</option>
                        <option value="processing">جاري التحضير</option>
                    </select>
                </div>
            </div>
            <div class="dash-container admin-only" id="adminStatsBar">
                <div class="dash-card"><div>مبيعات اليوم</div><div id="todaySales" class="stat-val">0 ج</div></div>
                <div class="dash-card"><div>إجمالي الطلبات</div><div id="totalCount" class="stat-val" style="color:var(--blue);">0</div></div>
                <div class="dash-card"><div>أوردرات ملغية</div><div id="cancelledCount" class="stat-val" style="color:var(--red);">0</div></div>
                <div class="dash-card"><div>الأكثر مبيعاً</div><div id="bestSellerName" style="color:var(--green); font-weight:bold; font-size:1.2rem; margin-top:5px;">-</div></div>
            </div>
            <table class="users-table">
                <thead><tr><th>#</th><th>الوقت</th><th>العميل</th><th>الهاتف</th><th>المبلغ</th><th>الحالة</th><th>الموظف</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <!-- 3. Reports -->
        <div id="reports" class="section">
            <div class="form-box">
                <h3>استخراج التقارير</h3>
                <input type="month" id="reportMonthInput">
                <button class="btn-blue" onclick="generateReport()">عرض التقرير</button>
                <button class="btn-blue" style="background:var(--green)" onclick="window.print()">طباعة</button>
            </div>
            <div id="reportResult" style="background:white; padding:20px; margin-top:20px; display:none;">
                <h3 style="text-align:center;">تقرير شهر <span id="repMonthName"></span></h3>
                <table class="users-table"><thead><tr><th>الموظف</th><th>عدد الطلبات المكتملة</th><th>إجمالي المبيعات</th></tr></thead><tbody id="reportTableBody"></tbody></table>
            </div>
        </div>

        <!-- 4. Products -->
        <div id="products" class="section">
            <div class="form-box">
                <h3>إضافة منتج/عرض</h3>
                <label>الاسم</label><input type="text" id="prodName">
                <label>رابط الصورة</label><input type="text" id="prodImg">
                <label>التصنيف</label><select id="prodCatSelect"></select>
                <div style="background:#f0f8ff; padding:15px; margin:15px 0; border:1px solid #bddfff; border-radius:5px;">
                    <h4 style="margin-top:0; color:var(--blue);">الخيارات</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="vType" placeholder="الوصف" style="flex:2;">
                        <input type="text" id="vSize" placeholder="الحجم" style="flex:1;">
                        <input type="number" id="vPrice" placeholder="السعر" style="flex:1;">
                    </div>
                    <button class="btn-blue" style="background:var(--green); width:auto;" id="addVarBtn">إضافة</button>
                    <div id="tempVarsDisplay" style="margin-top:15px;"></div>
                </div>
                <button class="btn-blue" style="width:100%" id="saveProdBtn">حفظ</button>
            </div>

            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- إضافة تصنيف -->
                <div class="form-box" style="flex: 1;">
                    <h3>إضافة تصنيف</h3>
                    <input type="text" id="catMain" placeholder="اسم التصنيف">
                    <button class="btn-blue" id="addCatBtn">إضافة</button>
                </div>

                <!-- إدارة التصنيفات (القسم الجديد) -->
                <div class="form-box" style="flex: 1;">
                    <h3>إدارة التصنيفات الحالية</h3>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>اسم التصنيف</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="manageCatsList">
                            <!-- سيتم تعبئة الجدول تلقائياً -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="manage-products" class="section">
            <h3>إدارة المنتجات</h3>
            <table class="users-table"><thead><tr><th>المنتج</th><th>الحالة</th><th>إجراء</th></tr></thead><tbody id="manageProdList"></tbody></table>
        </div>

        <!-- 5. Users -->
        <div id="users" class="section">
            <div class="form-box">
                <h3>إضافة موظف جديد</h3>
                <label>الاسم</label><input type="text" id="newUName">
                <label>الباسورد</label><input type="password" id="newUPass">
                <label>الصلاحية</label>
                <select id="newURole"><option value="receiver">متلقي طلبات</option><option value="admin">مدير</option></select>
                <button class="btn-blue" id="addUserBtn">إضافة</button>
            </div>
            <table class="users-table"><thead><tr><th>إجراءات</th><th>الصلاحية</th><th>الاسم</th></tr></thead><tbody id="usersListBody"></tbody></table>
        </div>

        <!-- 6. Chat -->
        <div id="chat" class="section">
            <div class="chat-layout">
                <div class="chat-list" id="chatUsersList"></div>
                <div class="chat-area">
                    <div style="flex:1; padding:20px; overflow-y:auto;" id="adminChatBox"></div>
                    <div style="padding:10px; display:flex;"><input id="adminChatInput" style="flex:1;"><button class="btn-blue" onclick="sendAdminMsg()">إرسال</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Order Details -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h2 style="color:var(--blue); text-align:center;">تفاصيل الطلب</h2>
            <div id="modalBody"></div>
            <div id="cancelAlert" style="display:none; background:#fff3cd; color:#856404; padding:15px; margin:10px 0; border:1px solid #ffeeba; border-radius:5px;">
                <strong><i class="fas fa-exclamation-triangle"></i> تنبيه:</strong> العميل يطلب إلغاء هذا الأوردر!
                <div style="margin-top:5px;"><strong>السبب:</strong> <span id="cancelReasonText"></span></div>
            </div>
            <div id="modalActions" style="display:flex; justify-content:center; gap:10px; margin-top:20px;"></div>
            <button onclick="document.getElementById('orderModal').style.display='none'" style="width:100%; margin-top:10px; background:#ccc; color:black;">إغلاق</button>
        </div>
    </div>

    <!-- Modal User Edit -->
    <div class="modal" id="userEditModal">
        <div class="modal-content">
            <h2 style="color:var(--blue); text-align:center;">تعديل بيانات الموظف</h2>
            <label>الاسم الجديد</label>
            <input type="text" id="editUName">
            <label>الباسورد الجديد</label>
            <input type="text" id="editUPass">
            <label>الصلاحية</label>
            <select id="editURole">
                <option value="receiver">متلقي طلبات</option>
                <option value="admin">مدير</option>
            </select>
            <button class="btn-blue" onclick="saveUserEdit()">حفظ التعديلات</button>
            <button onclick="document.getElementById('userEditModal').style.display='none'" style="width:100%; margin-top:10px; background:#ccc; color:black;">إغلاق</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAaf3l8VFttOCruK9jZczBsi1eBwg2U5yE", authDomain: "nagaf-f9b1c.firebaseapp.com", projectId: "nagaf-f9b1c", databaseURL: "https://nagaf-f9b1c-default-rtdb.firebaseio.com", storageBucket: "nagaf-f9b1c.appspot.com", messagingSenderId: "840123927886", appId: "1:840123927886:web:c6baad7f059cfab461e21f" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Load user from Storage immediately ---
        let currentUser = JSON.parse(localStorage.getItem('nagaf_staff_user'));
        let activeChatUser = null;
        let tempVariants = [];
        let allOrders = {};
        let allUsersData = {};
        let chatsLoaded = false;
        let editingUserKey = null;

        if(currentUser) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminNameDisplay').innerText = currentUser.name;
            if(currentUser.role === 'receiver') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                document.getElementById('adminStatsBar').style.display = 'none';
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.getElementById('adminStatsBar').style.display = 'flex';
            }
            startSystem();
        }

        // Login
        document.getElementById('loginBtn').addEventListener('click', () => {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(!u || !p) return alert("أدخل البيانات");
            onValue(ref(db, 'users'), (snap) => {
                let found = null;
                const users = snap.val() || {};
                if(u === 'admin' && p === '123') found = {name: 'Admin', role: 'admin'};
                else Object.values(users).forEach(user => { if(user.name === u && user.pass === p) found = user; });
                
                if(found) {
                    currentUser = found;
                    localStorage.setItem('nagaf_staff_user', JSON.stringify(found));

                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminNameDisplay').innerText = found.name;
                    if(found.role === 'receiver') {
                        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                        document.getElementById('adminStatsBar').style.display = 'none';
                    } else {
                        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                        document.getElementById('adminStatsBar').style.display = 'flex';
                    }
                    startSystem();
                } else alert('خطأ في البيانات');
            }, {onlyOnce: true});
        });

        // Logout
        window.logoutStaff = function() {
            localStorage.removeItem('nagaf_staff_user');
            location.reload();
        }

        window.nav = function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(id === 'chat') {
                document.getElementById('chatNotifyDot').style.display = 'none';
            }
        }

        function startSystem() {
            onValue(ref(db, 'orders'), (s) => { 
                allOrders = s.val() || {}; 
                renderOrders(allOrders); 
                updateStats(allOrders); 
            });
            onValue(ref(db, 'users'), (s) => {
                allUsersData = s.val() || {};
                renderUsers(allUsersData);
            });
            onValue(ref(db, 'products'), (s) => renderProdManage(s.val() || {}));
            
            // --- تعديل: قراءة التصنيفات للملء وللإدارة ---
            onValue(ref(db, 'categories'), (s) => {
                const cats = s.val() || {};
                populateCats(cats);      // يملأ القائمة المنسدلة
                renderCatManage(cats);   // يملأ جدول الإدارة (للحذف والتعديل)
            });

            onValue(ref(db, 'chats'), (s) => handleChatUpdate(s.val() || {}));
        }

        // --- Orders Logic ---
        function renderOrders(data) {
            const n = document.getElementById('newOrdersList'), p = document.getElementById('processingOrdersList');
            n.innerHTML = ''; p.innerHTML = '';
            let hasNewOrder = false;

            Object.entries(data).forEach(([k,o]) => {
                const c = `<div class="order-card ${o.cancelRequest?'cancel-requested':''}" onclick="openOrder('${k}')">
                    ${o.cancelRequest ? '<span class="cancel-badge">طلب إلغاء!</span>' : ''}
                    <h4>#${k.slice(-4)} - ${o.customerName}</h4>
                    <div>${o.phone}</div>
                    <div>${o.address}</div>
                    <div>${o.total} ج</div>
                </div>`;
                if(o.status === 'pending' || o.status === 'new') {
                    n.innerHTML += c;
                    if(!o.seenByAdmin) { hasNewOrder = true; update(ref(db,'orders/'+k),{seenByAdmin:true}); }
                } else if(o.status === 'processing') p.innerHTML += c;
            });

            const alarm = document.getElementById('alarmSound');
            if(hasNewOrder) {
                alarm.currentTime = 0;
                alarm.play().catch(()=>{});
            }
        }

        window.filterHistory = function() {
            updateStats(allOrders);
        }

        window.openOrder = function(k) {
            const alarm = document.getElementById('alarmSound');
            alarm.pause();
            alarm.currentTime = 0;

            const o = allOrders[k]; if(!o) return;
            
            const items = (o.items || o.cart || []).map(i => {
                let noteHtml = '';
                if(i.note && i.note.trim() !== '') {
                    noteHtml = `<span class="item-note">⚠️ ${i.note}</span>`;
                }
                return `<li>
                    <div style="margin-bottom:5px;">
                        ${i.name} ${i.variant ? `(${i.variant.bread} ${i.variant.size != 'موحد' ? '- ' + i.variant.size : ''})` : ''} 
                        - <strong>${i.variant ? i.variant.price : i.price} ج</strong>
                    </div>
                    ${noteHtml}
                </li>`;
            }).join('');
            
            let extraInfo = '';
            if(o.status === 'cancelled') {
                if(o.adminReason) extraInfo = `<div class="reason-box"><strong>تم الإلغاء/الرفض بواسطة الإدارة:</strong><br>${o.adminReason}</div>`;
                else if(o.cancelReason) extraInfo = `<div class="reason-box"><strong>تم الإلغاء بطلب من العميل:</strong><br>${o.cancelReason}</div>`;
            }

            document.getElementById('modalBody').innerHTML = `<p><strong>${o.customerName}</strong> (${o.phone})</p><p>${o.address}</p><hr><ul style="padding-right:20px; line-height:1.8;">${items}</ul>${extraInfo}<h3 style="color:var(--red)">${o.total} ج</h3>`;
            
            const act = document.getElementById('modalActions');
            const alertBox = document.getElementById('cancelAlert');
            act.innerHTML = ''; 

            if(o.cancelRequest) {
                alertBox.style.display = 'block';
                document.getElementById('cancelReasonText').innerText = o.cancelReason;
                act.innerHTML = `<button class="btn-red" onclick="rejectOrder('${k}')">✔ موافقة على الإلغاء</button><button class="btn-blue" onclick="rejCancelReq('${k}')">✖ رفض (استكمال الطلب)</button>`;
            } else {
                alertBox.style.display = 'none';
                if(o.status==='pending'||o.status==='new') act.innerHTML = `<button class="btn-blue" style="background:var(--green)" onclick="upStatus('${k}','processing')">قبول وتجهيز</button><button class="btn-red" onclick="rejectOrder('${k}')">رفض</button>`;
                else if(o.status==='processing') act.innerHTML = `<button class="btn-blue" onclick="upStatus('${k}','completed')">إنهاء</button>`;
            }
            document.getElementById('orderModal').style.display = 'block';
        }

        window.upStatus = (k,s) => { update(ref(db,'orders/'+k), {status:s, handledBy:currentUser.name}); document.getElementById('orderModal').style.display='none'; }
        window.rejectOrder = function(k) {
            let reason = prompt("يرجى كتابة سبب الرفض/الإلغاء (سيظهر للعميل وفي السجل):");
            if(reason) {
                update(ref(db,'orders/'+k), { status: 'cancelled', adminReason: reason, cancelRequest: false, handledBy:currentUser.name });
                document.getElementById('orderModal').style.display = 'none';
            }
        }
        window.rejCancelReq = (k) => { update(ref(db,'orders/'+k), {cancelRequest:false}); document.getElementById('orderModal').style.display='none'; }

        function updateStats(data) {
            let list = Object.entries(data).map(([k,v]) => ({...v, key: k})).reverse();
            
            if(document.getElementById('adminStatsBar').style.display !== 'none') {
                let comp = list.filter(o => o.status === 'completed');
                let totalSales = comp.reduce((s,o) => s + (parseInt(o.total)||0), 0);
                let cancelledCount = list.filter(o => o.status === 'cancelled').length;
                document.getElementById('todaySales').innerText = totalSales + ' ج';
                document.getElementById('totalCount').innerText = list.length; 
                document.getElementById('cancelledCount').innerText = cancelledCount; 
            }

            const term = document.getElementById('searchPhoneInput').value;
            const statusFilter = document.getElementById('filterStatus').value;

            if(term) list = list.filter(o => o.phone.includes(term));
            
            if(statusFilter !== 'all') {
                if(statusFilter === 'processing') list = list.filter(o => o.status === 'pending' || o.status === 'new' || o.status === 'processing');
                else list = list.filter(o => o.status === statusFilter);
            }

            document.getElementById('historyTableBody').innerHTML = list.map(o => `
                <tr class="clickable-row" onclick="openOrder('${o.key}')">
                    <td>#${o.key.slice(-4)}</td>
                    <td>${new Date(o.timestamp).toLocaleTimeString('ar-EG')}</td>
                    <td>${o.customerName}</td>
                    <td>${o.phone}</td>
                    <td>${o.total} ج</td>
                    <td style="color:${o.status==='completed'?'green':(o.status==='cancelled'?'red':'orange')}">${o.status==='completed'?'مكتمل':(o.status==='cancelled'?'ملغي':'جاري')}</td>
                    <td>${o.handledBy||'-'}</td>
                </tr>`).join('');
        }

        // --- Reports Logic ---
        window.generateReport = function() {
            const m = document.getElementById('reportMonthInput').value; // yyyy-mm
            if(!m) return alert("الرجاء اختيار الشهر أولاً");

            const [year, month] = m.split('-');
            const reportData = {};

            Object.values(allOrders).forEach(o => {
                if(o.status === 'completed') {
                    const d = new Date(o.timestamp);
                    if(d.getFullYear() == year && (d.getMonth() + 1) == month) {
                        const emp = o.handledBy || 'غير محدد';
                        if(!reportData[emp]) reportData[emp] = { count: 0, total: 0 };
                        
                        reportData[emp].count += 1;
                        reportData[emp].total += (parseInt(o.total) || 0);
                    }
                }
            });

            document.getElementById('repMonthName').innerText = m;
            document.getElementById('reportResult').style.display = 'block';
            
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            
            if(Object.keys(reportData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">لا توجد مبيعات في هذا الشهر</td></tr>';
            } else {
                Object.entries(reportData).forEach(([name, data]) => {
                    tbody.innerHTML += `<tr><td>${name}</td><td>${data.count}</td><td>${data.total} ج</td></tr>`;
                });
            }
        }

        // --- User Management ---
        document.getElementById('addUserBtn').addEventListener('click', () => { 
            let u=document.getElementById('newUName').value, p=document.getElementById('newUPass').value, r=document.getElementById('newURole').value; 
            if(u&&p){ push(ref(db,'users'),{name:u,pass:p,role:r}); alert('تمت الإضافة'); document.getElementById('newUName').value=''; document.getElementById('newUPass').value=''; }
        });

        function renderUsers(data) { 
            const t=document.getElementById('usersListBody'); 
            t.innerHTML=''; 
            Object.entries(data).forEach(([k,u])=>{ 
                if(u.role!=='customer') {
                    t.innerHTML+=`
                    <tr>
                        <td>
                            <button class="btn-red" onclick="window.delUser('${k}')">حذف</button>
                            <button class="btn-warning" onclick="window.openEditUser('${k}')">تعديل</button>
                        </td>
                        <td>${u.role==='admin'?'مدير':'متلقي طلبات'}</td>
                        <td>${u.name}</td>
                    </tr>`; 
                }
            }); 
        }

        window.delUser=(k)=>confirm('هل أنت متأكد من الحذف؟')&&remove(ref(db,'users/'+k));

        window.openEditUser = function(key) {
            const u = allUsersData[key];
            if(!u) return;
            editingUserKey = key;
            document.getElementById('editUName').value = u.name;
            document.getElementById('editUPass').value = u.pass;
            document.getElementById('editURole').value = u.role;
            document.getElementById('userEditModal').style.display = 'flex';
        }

        window.saveUserEdit = function() {
            if(!editingUserKey) return;
            const n = document.getElementById('editUName').value;
            const p = document.getElementById('editUPass').value;
            const r = document.getElementById('editURole').value;
            
            if(n && p) {
                update(ref(db, 'users/' + editingUserKey), { name: n, pass: p, role: r })
                .then(() => {
                    alert("تم حفظ التعديلات");
                    document.getElementById('userEditModal').style.display = 'none';
                    editingUserKey = null;
                });
            } else {
                alert("يرجى ملء جميع الحقول");
            }
        }

        // --- Other Management & Chat ---
        function handleChatUpdate(chats) {
            renderChatList(chats);
            if(chatsLoaded) {
                let hasNew = false;
                Object.values(chats).forEach(msgs => {
                    const lastMsg = Object.values(msgs).pop();
                    if(lastMsg && lastMsg.sender === 'customer' && Date.now() - lastMsg.timestamp < 10000) hasNew = true;
                });
                if(hasNew) { document.getElementById('msgSound').play().catch(()=>{}); document.getElementById('chatNotifyDot').style.display = 'block'; }
            } else chatsLoaded = true;
            if(activeChatUser) loadAdminChat(activeChatUser);
        }

        function renderChatList(d) {
            document.getElementById('chatUsersList').innerHTML = Object.keys(d).map(k => {
                const msgs = Object.values(d[k]); const last = msgs[msgs.length-1]; const isNew = last.sender === 'customer' ? 'has-new' : '';
                return `<div class="chat-user-item ${isNew}" onclick="window.loadChat('${k}')"><span>${k}</span> <small>${last.text.substring(0,10)}...</small></div>`;
            }).join('');
        }
        window.loadChat = (p) => { activeChatUser = p; onValue(ref(db,'chats/'+p), s => { document.getElementById('adminChatBox').innerHTML = Object.values(s.val()||{}).map(m=>`<div style="background:${m.sender==='admin'?'var(--blue)':'#ddd'};color:${m.sender==='admin'?'white':'black'};padding:8px;margin:5px;width:fit-content;border-radius:5px;align-self:${m.sender==='admin'?'flex-end':'flex-start'}">${m.text}</div>`).join(''); }); }
        window.sendAdminMsg = () => { let t=document.getElementById('adminChatInput').value; if(t&&activeChatUser){ push(ref(db,'chats/'+activeChatUser),{sender:'admin',text:t, timestamp:Date.now()}); document.getElementById('adminChatInput').value=''; } };
        document.getElementById('addVarBtn').addEventListener('click', () => { let b=document.getElementById('vType').value, s=document.getElementById('vSize').value, p=document.getElementById('vPrice').value; if(b && p) { tempVariants.push({bread:b,size:s||'موحد',price:parseInt(p)}); document.getElementById('tempVarsDisplay').innerHTML += `<span class="variant-tag">${b} (${s||'موحد'}) : ${p}ج</span>`; document.getElementById('vType').value=''; document.getElementById('vSize').value=''; document.getElementById('vPrice').value=''; } });
        document.getElementById('saveProdBtn').addEventListener('click', () => { let n=document.getElementById('prodName').value, i=document.getElementById('prodImg').value, c=document.getElementById('prodCatSelect').value; if(n && tempVariants.length) { push(ref(db,'products'),{name:n,img:i,cat:c,variants:tempVariants,available:true}); alert('تم'); tempVariants=[]; document.getElementById('prodName').value=''; document.getElementById('tempVarsDisplay').innerHTML=''; } });
        document.getElementById('addCatBtn').addEventListener('click', () => { let n=document.getElementById('catMain').value; if(n){ push(ref(db,'categories'),{name:n}); alert('تم'); } });
        
        // --- دالة ملء القائمة المنسدلة ---
        function populateCats(data) { 
            const s=document.getElementById('prodCatSelect'); 
            s.innerHTML='<option value="" disabled selected>اختر</option>'; 
            Object.values(data).forEach(c=>s.innerHTML+=`<option value="${c.name}">${c.name}</option>`); 
        }

        // --- دوال إدارة التصنيفات الجديدة ---
        function renderCatManage(data) {
            const tbody = document.getElementById('manageCatsList');
            tbody.innerHTML = '';
            if(!data || Object.keys(data).length === 0) {
                tbody.innerHTML = '<tr><td colspan="2">لا توجد تصنيفات</td></tr>';
                return;
            }
            Object.entries(data).forEach(([key, cat]) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${cat.name}</td>
                        <td>
                            <button class="btn-warning" onclick="window.editCat('${key}', '${cat.name}')">تعديل</button>
                            <button class="btn-red" onclick="window.delCat('${key}')">حذف</button>
                        </td>
                    </tr>
                `;
            });
        }

        window.delCat = function(key) {
            if(confirm('هل أنت متأكد من حذف هذا التصنيف؟')) {
                remove(ref(db, 'categories/' + key))
                .then(() => alert('تم الحذف'))
                .catch(err => alert('خطأ: ' + err));
            }
        }

        window.editCat = function(key, oldName) {
            let newName = prompt("اسم التصنيف الجديد:", oldName);
            if(newName && newName !== oldName) {
                update(ref(db, 'categories/' + key), { name: newName })
                .then(() => alert('تم التعديل'))
                .catch(err => alert('خطأ: ' + err));
            }
        }

        function renderProdManage(data) { document.getElementById('manageProdList').innerHTML=Object.entries(data).map(([k,p])=>`<tr><td>${p.name}</td><td>${p.available?'متاح':'مغلق'}</td><td><button class="btn-blue" onclick="window.tog('${k}',${p.available})">تغيير</button><button class="btn-red" onclick="window.delP('${k}')">حذف</button></td></tr>`).join(''); }
        window.tog=(k,s)=>update(ref(db,'products/'+k),{available:!s}); window.delP=(k)=>confirm('حذف؟')&&remove(ref(db,'products/'+k));
    </script>
</body>
</html>
