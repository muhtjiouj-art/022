<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مطعم نجف - طلب أونلاين</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { 
            --blue: #1a237e; /* أزرق غامق زي الصورة */
            --red: #9e0000;  /* أحمر غامق زي الصورة */
            --white: #ffffff; 
            --gray: #f5f5f5; 
            --text-color: #333;
        }
        
        * { box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: var(--gray); 
            padding-bottom: 80px; /* مسافة للشات والسلة */
        }

        /* --- الهيدر --- */
        header { 
            background: linear-gradient(to left, var(--blue), #283593); 
            color: var(--white); 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
        }
        .logo { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        
        .user-controls { display: flex; gap: 15px; align-items: center; }
        .icon-btn { position: relative; cursor: pointer; font-size: 1.2rem; }
        .badge { 
            position: absolute; top: -8px; right: -8px; 
            background: var(--red); color: white; 
            border-radius: 50%; padding: 2px 5px; 
            font-size: 0.7rem; font-weight: bold; border: 1px solid white;
        }

        /* --- البانر (Hero) --- */
        .hero { 
            background: linear-gradient(rgba(26, 35, 126, 0.7), rgba(158, 0, 0, 0.7)), url('https://source.unsplash.com/800x400/?food,restaurant') center/cover;
            height: 180px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            color: white; 
            margin-bottom: 15px;
        }
        .hero h1 { font-size: 1.8rem; margin: 0; text-shadow: 1px 1px 3px black; }
        .hero p { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }

        /* --- التصنيفات (Categories) --- */
        .category-nav { 
            display: flex; 
            overflow-x: auto; 
            padding: 10px; 
            gap: 10px; 
            background: white; 
            white-space: nowrap; 
            -webkit-overflow-scrolling: touch; /* نعومة التمرير في الآيفون */
        }
        .category-nav::-webkit-scrollbar { display: none; } /* إخفاء السكرول بار */
        
        .cat-btn { 
            background: white; 
            color: var(--blue); 
            border: 1px solid var(--blue); 
            padding: 8px 20px; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            font-weight: bold; 
            cursor: pointer; 
            flex-shrink: 0; 
            transition: 0.2s;
        }
        .cat-btn.active, .cat-btn:hover { background: var(--blue); color: white; }

        /* --- شبكة المنتجات (Responsive) --- */
        .container { padding: 10px; max-width: 1200px; margin: 0 auto; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* عمودين للموبايل */
            gap: 10px; 
        }

        /* تعديلات للموبايل */
        @media (min-width: 768px) {
            .grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
            .hero { height: 250px; }
            .hero h1 { font-size: 2.5rem; }
        }

        .card { 
            background: white; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            border: 1px solid #eee;
        }
        .card img { 
            width: 100%; 
            height: 120px; /* ارتفاع مناسب للموبايل */
            object-fit: cover; 
        }
        .card-body { 
            padding: 10px; 
            text-align: center; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
        }
        .card h3 { 
            margin: 5px 0; 
            font-size: 1rem; 
            color: var(--text-color); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .price-tag { font-size: 0.9rem; color: #666; margin-bottom: 8px; }
        
        .btn { 
            background: var(--blue); 
            color: white; 
            border: none; 
            padding: 8px; 
            width: 100%; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: bold; 
        }
        .btn:active { transform: scale(0.98); }

        /* --- المودال (التسجيل والتفاصيل) --- */
        .modal { 
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 2000; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(3px);
            padding: 15px; /* مسافة من الحواف في الموبايل */
        }
        .modal-content { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            width: 100%; 
            max-width: 400px; /* عرض مناسب زي الصورة */
            position: relative; 
            max-height: 90vh; 
            overflow-y: auto; 
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        .close-btn { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; color: #999; cursor: pointer; }

        /* --- تصميم فورم التسجيل (زي الصورة) --- */
        .auth-header { text-align: center; color: var(--blue); margin-bottom: 20px; font-size: 1.5rem; font-weight: bold; }
        .input-group { margin-bottom: 10px; }
        .custom-input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            font-family: inherit; 
            font-size: 0.95rem;
        }
        .btn-login { 
            background: var(--blue); 
            color: white; 
            padding: 12px; 
            width: 100%; 
            border: none; 
            border-radius: 5px; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .divider-text { 
            text-align: center; 
            color: var(--red); 
            margin: 20px 0; 
            font-weight: bold; 
            font-size: 0.95rem; 
        }
        .btn-register { 
            background: #9e0000; /* أحمر غامق */
            color: white; 
            padding: 12px; 
            width: 100%; 
            border: none; 
            border-radius: 5px; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
        }

        /* --- سلة المشتريات وقائمة الطلبات --- */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .remove-icon { color: var(--red); cursor: pointer; padding: 5px; }

        /* --- الشات --- */
        .chat-float { 
            position: fixed; bottom: 20px; left: 20px; 
            background: var(--blue); color: white; 
            width: 55px; height: 55px; 
            border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.5rem; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            z-index: 2500; cursor: pointer; border: 2px solid white;
        }
        .chat-window {
            display: none; position: fixed; bottom: 85px; left: 15px; 
            width: 300px; height: 400px; 
            background: white; border-radius: 15px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.2); 
            z-index: 2500; flex-direction: column; overflow: hidden;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3"></audio>

    <header>
        <div class="logo"><i class="fas fa-utensils"></i> نجف | NAGAF</div>
        <div class="user-controls">
            <!-- أيقونة البروفايل -->
            <div id="userIcon" style="display:none;" onclick="openProfile()">
                <i class="fas fa-user-circle"></i> <span id="uNameDisplay" style="font-size:0.8rem;"></span>
            </div>
            <!-- زر الدخول -->
            <div id="loginBtnNav" onclick="openAuth()">
                <i class="fas fa-sign-in-alt"></i> دخول
            </div>
            <!-- السجل -->
            <div class="icon-btn" onclick="openMyOrders()"><i class="fas fa-clipboard-list"></i></div>
            <!-- السلة -->
            <div class="icon-btn" onclick="openCart()">
                <i class="fas fa-shopping-cart"></i> 
                <span class="badge" id="cartCount">0</span>
            </div>
        </div>
    </header>

    <div class="hero">
        <div>
            <h1>أصل الأكل المصري</h1>
            <p>أطلب واستمتع بالطعم الأصلي</p>
        </div>
    </div>

    <div class="category-nav" id="categoryNav">
        <!-- يتم ملؤها بالجافاسكريبت -->
    </div>

    <div class="container">
        <div class="grid" id="productGrid">
            <!-- المنتجات -->
        </div>
    </div>

    <!-- ========================================== -->
    <!--  مودال التسجيل (مطابق للصورة)  -->
    <!-- ========================================== -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('authModal')">&times;</span>
            
            <!-- قسم تسجيل الدخول -->
            <h2 class="auth-header">تسجيل الدخول</h2>
            <div class="input-group">
                <input type="email" id="loginEmail" class="custom-input" placeholder="البريد الإلكتروني">
            </div>
            <div class="input-group">
                <input type="password" id="loginPass" class="custom-input" placeholder="كلمة المرور">
            </div>
            <button class="btn-login" onclick="handleLogin()">دخول</button>

            <!-- الفاصل -->
            <div class="divider-text">ليس لديك حساب؟ سجل الآن</div>

            <!-- قسم التسجيل الجديد -->
            <div class="input-group">
                <input type="text" id="regName" class="custom-input" placeholder="الاسم">
            </div>
            <div class="input-group">
                <input type="tel" id="regPhone" class="custom-input" placeholder="رقم الهاتف">
            </div>
            <div class="input-group">
                <select id="regZone" class="custom-input">
                    <option value="" disabled selected>اختر المنطقة</option>
                    <option value="المعادي">المعادي</option>
                    <option value="مدينة نصر">مدينة نصر</option>
                    <option value="مصر الجديدة">مصر الجديدة</option>
                    <option value="وسط البلد">وسط البلد</option>
                    <option value="الهرم">الهرم</option>
                    <option value="أخرى">منطقة أخرى</option>
                </select>
            </div>
            <div class="input-group">
                <input type="text" id="regAddress" class="custom-input" placeholder="اسم الشارع ورقم العقار">
            </div>
            <button class="btn-register" onclick="handleRegister()">تسجيل جديد</button>
        </div>
    </div>

    <!-- مودال خيارات المنتج -->
    <div class="modal" id="optionsModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('optionsModal')">&times;</span>
            <h3 id="optProdName" style="color:var(--blue); text-align:center; margin-top:0;"></h3>
            <div id="variantsList" style="margin:15px 0;"></div>
            <h4 style="text-align:center; color:var(--red);">السعر: <span id="selectedPrice">0</span> جنيه</h4>
            <button class="btn" style="margin-top:10px;" onclick="confirmAddToCart()">تأكيد الإضافة</button>
        </div>
    </div>

    <!-- مودال السلة -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('cartModal')">&times;</span>
            <h2 style="color:var(--blue); text-align:center;">سلة المشتريات</h2>
            <div id="cartItems" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
            <div style="text-align:center; font-weight:bold; font-size:1.1rem; margin-bottom:15px;">
                الإجمالي: <span id="cartTotal" style="color:var(--red);">0</span> جنيه
            </div>
            <button class="btn" onclick="submitOrder()">إرسال الطلب</button>
        </div>
    </div>

    <!-- مودال السجل -->
    <div class="modal" id="ordersModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('ordersModal')">&times;</span>
            <h2 style="text-align:center; color:var(--blue);">سجل طلباتي</h2>
            <div id="ordersList" style="max-height:60vh; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- زر الشات -->
    <div class="chat-float" onclick="toggleChat()"><i class="fas fa-comments"></i></div>
    
    <div class="chat-window" id="chatWindow">
        <div style="background:var(--blue); color:white; padding:10px; display:flex; justify-content:space-between;">
            <span>خدمة العملاء</span><span onclick="toggleChat()" style="cursor:pointer;">✖</span>
        </div>
        <div id="chatBody" style="flex:1; padding:10px; overflow-y:auto; background:#f9f9f9; display:flex; flex-direction:column; gap:8px;"></div>
        <div style="padding:10px; border-top:1px solid #ddd; display:flex;">
            <input type="text" id="chatInput" placeholder="اكتب..." style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; margin-left:5px;">
            <button onclick="sendChat()" style="background:var(--blue); color:white; border:none; padding:0 15px; border-radius:4px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAaf3l8VFttOCruK9jZczBsi1eBwg2U5yE",
            authDomain: "nagaf-f9b1c.firebaseapp.com",
            projectId: "nagaf-f9b1c",
            databaseURL: "https://nagaf-f9b1c-default-rtdb.firebaseio.com",
            storageBucket: "nagaf-f9b1c.appspot.com",
            messagingSenderId: "840123927886",
            appId: "1:840123927886:web:c6baad7f059cfab461e21f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let cart = [];
        let currentUser = JSON.parse(localStorage.getItem('nagaf_user_info'));
        let products = [];
        let selectedProductTemp = null;
        let selectedVariantTemp = null;

        // --- تحميل المنتجات ---
        onValue(ref(db, 'products'), (snapshot) => {
            const data = snapshot.val() || {};
            products = Object.values(data);
            loadProducts('all');
        });

        // --- تحميل التصنيفات ---
        onValue(ref(db, 'categories'), (snapshot) => {
            const data = snapshot.val() || {};
            const nav = document.getElementById('categoryNav');
            nav.innerHTML = '<button class="cat-btn active" onclick="window.filterCat(\'all\', this)">الكل</button>';
            Object.values(data).forEach(c => {
                nav.innerHTML += `<button class="cat-btn" onclick="window.filterCat('${c.name}', this)">${c.name}</button>`;
            });
        });

        window.filterCat = function(cat, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadProducts(cat);
        }

        window.loadProducts = function(cat) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            
            products.forEach(p => {
                if((cat === 'all' || p.cat === cat) && p.available) {
                    const minPrice = p.variants ? Math.min(...p.variants.map(v=>v.price)) : 0;
                    grid.innerHTML += `
                        <div class="card" onclick="window.openOptions('${p.name}')">
                            <img src="${p.img}" alt="${p.name}">
                            <div class="card-body">
                                <h3>${p.name}</h3>
                                <div class="price-tag">يبدأ من ${minPrice} جنيه</div>
                                <button class="btn">أطلب الآن</button>
                            </div>
                        </div>`;
                }
            });
        }

        // --- تسجيل الدخول والتسجيل (Logic) ---
        if(currentUser) setupUserUI();
        
        window.openAuth = function() { document.getElementById('authModal').style.display = 'flex'; }
        
        window.handleRegister = function() {
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const zone = document.getElementById('regZone').value;
            const address = document.getElementById('regAddress').value;

            if(name && phone && zone && address) {
                // حفظ البيانات
                currentUser = { 
                    name: name, 
                    phone: phone, 
                    address: `${zone} - ${address}`, // دمج المنطقة مع العنوان
                    zone: zone 
                };
                localStorage.setItem('nagaf_user_info', JSON.stringify(currentUser));
                
                // حفظ في قاعدة البيانات (اختياري)
                push(ref(db, 'users'), { ...currentUser, role: 'customer' });

                setupUserUI();
                closeModal('authModal');
                alert('تم التسجيل بنجاح!');
            } else {
                alert('يرجى ملء جميع الحقول (الاسم، الهاتف، المنطقة، العنوان)');
            }
        }

        window.handleLogin = function() {
            // محاكاة تسجيل الدخول (في التطبيق الحقيقي تحقق من قاعدة البيانات)
            const email = document.getElementById('loginEmail').value;
            if(email) {
                alert('يرجى استخدام نموذج "تسجيل جديد" للعملاء الجدد، أو سيتم تفعيل الدخول لاحقاً.');
            } else {
                alert('ادخل البريد الإلكتروني');
            }
        }

        function setupUserUI() {
            document.getElementById('loginBtnNav').style.display = 'none';
            document.getElementById('userIcon').style.display = 'flex';
            document.getElementById('uNameDisplay').innerText = currentUser.name.split(' ')[0];
        }

        // --- السلة ---
        window.openOptions = function(prodName) {
            selectedProductTemp = products.find(p => p.name === prodName);
            document.getElementById('optProdName').innerText = selectedProductTemp.name;
            const list = document.getElementById('variantsList');
            list.innerHTML = '';
            
            selectedProductTemp.variants.forEach((v, i) => {
                const borderStyle = i === 0 ? 'border:2px solid var(--blue); background:#eef;' : 'border:1px solid #ddd;';
                list.innerHTML += `
                <div onclick="selectVar(${i}, this)" 
                     style="padding:10px; margin-bottom:5px; border-radius:5px; cursor:pointer; display:flex; justify-content:space-between; ${borderStyle}"
                     data-price="${v.price}">
                    <span>${v.bread} - ${v.size}</span>
                    <span style="font-weight:bold; color:var(--red)">${v.price} ج</span>
                </div>`;
            });
            window.selectVar(0, list.children[0]); // اختر الأول تلقائياً
            document.getElementById('optionsModal').style.display = 'flex';
        }

        window.selectVar = function(i, el) {
            Array.from(el.parentElement.children).forEach(c => {
                c.style.border = '1px solid #ddd';
                c.style.background = 'white';
            });
            el.style.border = '2px solid var(--blue)';
            el.style.background = '#eef';
            
            selectedVariantTemp = selectedProductTemp.variants[i];
            document.getElementById('selectedPrice').innerText = selectedVariantTemp.price;
        }

        window.confirmAddToCart = function() {
            cart.push({...selectedProductTemp, variant: selectedVariantTemp});
            updateCart();
            closeModal('optionsModal');
        }

        function updateCart() {
            document.getElementById('cartCount').innerText = cart.length;
            const div = document.getElementById('cartItems');
            let total = 0;
            div.innerHTML = cart.map((i, idx) => {
                total += i.variant.price;
                return `
                <div class="cart-item">
                    <div>
                        <div style="font-weight:bold;">${i.name}</div>
                        <div style="font-size:0.85rem; color:#666;">${i.variant.bread} | ${i.variant.size}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>${i.variant.price} ج</span>
                        <i class="fas fa-trash remove-icon" onclick="window.remItem(${idx})"></i>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('cartTotal').innerText = total;
        }

        window.remItem = function(i) { cart.splice(i,1); updateCart(); }
        window.openCart = function() { document.getElementById('cartModal').style.display = 'flex'; }
        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }

        // --- إرسال الطلب ---
        window.submitOrder = function() {
            if(!currentUser) {
                closeModal('cartModal');
                return openAuth();
            }
            if(cart.length === 0) return alert('السلة فارغة');
            
            const total = parseInt(document.getElementById('cartTotal').innerText);

            push(ref(db, 'orders'), {
                customerName: currentUser.name,
                phone: currentUser.phone,
                address: currentUser.address,
                items: cart,
                total: total,
                status: 'pending',
                timestamp: Date.now(),
                seenByAdmin: false
            }).then(() => {
                // ================================
                // الرسالة المطلوبة
                // ================================
                alert("تم الإرسال بنجاح! تابع طلبك في السجل.");
                
                cart = []; 
                updateCart();
                closeModal('cartModal');
                window.openMyOrders(); // فتح السجل تلقائياً
            }).catch(e => {
                alert("حدث خطأ في الاتصال");
            });
        }

        // --- السجل والشات ---
        window.openMyOrders = function() {
            if(!currentUser) return openAuth();
            onValue(ref(db, 'orders'), (snap) => {
                const data = snap.val() || {};
                const list = document.getElementById('ordersList');
                list.innerHTML = '';
                
                const myOrders = Object.values(data).filter(o => o.phone === currentUser.phone).reverse();
                
                if(myOrders.length === 0) list.innerHTML = '<p style="text-align:center; padding:20px;">لا توجد طلبات سابقة</p>';

                myOrders.forEach(o => {
                    let stText = 'قيد الانتظار';
                    let stColor = 'orange';
                    if(o.status === 'processing') { stText = 'جاري التحضير'; stColor = 'blue'; }
                    if(o.status === 'completed') { stText = 'مكتمل'; stColor = 'green'; }
                    if(o.status === 'cancelled') { stText = 'ملغي'; stColor = 'red'; }

                    list.innerHTML += `
                    <div style="background:#f9f9f9; border:1px solid #eee; padding:10px; margin-bottom:10px; border-radius:5px;">
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span>${o.total} جنيه</span>
                            <span style="color:${stColor}">${stText}</span>
                        </div>
                        <div style="font-size:0.85rem; color:#666; margin-top:5px;">${new Date(o.timestamp).toLocaleString('ar-EG')}</div>
                        <div style="font-size:0.9rem; margin-top:5px;">${o.items.map(i=>i.name).join(', ')}</div>
                        ${o.rejectionReason ? `<div style="color:red; font-size:0.85rem; margin-top:5px; background:#fee; padding:5px;">ملاحظة: ${o.rejectionReason}</div>` : ''}
                    </div>`;
                });
                document.getElementById('ordersModal').style.display = 'flex';
            });
        }

        window.toggleChat = function() {
            const w = document.getElementById('chatWindow');
            w.style.display = w.style.display === 'none' ? 'flex' : 'none';
            if(currentUser && w.style.display === 'flex') loadChat();
        }

        window.sendChat = function() {
            const t = document.getElementById('chatInput').value;
            if(t && currentUser) {
                push(ref(db, 'chats/'+currentUser.phone), {sender:'customer', text:t});
                document.getElementById('chatInput').value = '';
            } else if (!currentUser) {
                openAuth();
            }
        }

        function loadChat() {
            onValue(ref(db, 'chats/'+currentUser.phone), (snap) => {
                const msgs = snap.val() || {};
                document.getElementById('chatBody').innerHTML = Object.values(msgs).map(m => `
                    <div style="align-self:${m.sender==='customer'?'flex-start':'flex-end'}; 
                                background:${m.sender==='customer'?'var(--blue)':'#ddd'}; 
                                color:${m.sender==='customer'?'white':'black'}; 
                                padding:8px 12px; border-radius:10px; max-width:80%; font-size:0.9rem;">
                        ${m.text}
                    </div>`).join('');
            });
        }
    </script>
</body>
</html>
